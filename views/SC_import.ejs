<script src="../EAO/web3.js"></script>

<script type="text/javascript">

    var Web3 = require('web3');
    var provider = 'http://220.76.95.91:8546';
    var abi = [{"constant":false,"inputs":[{"name":"_contractFile","type":"string"},{"name":"_contractHash","type":"bytes32"}],"name":"issue","outputs":[],"payable":false,"type":"function","stateMutability":"nonpayable"},{"constant":true,"inputs":[],"name":"getContracts","outputs":[{"name":"","type":"bytes32[]"}],"payable":false,"type":"function","stateMutability":"view"},{"constant":true,"inputs":[{"name":"_contractHash","type":"bytes32"}],"name":"getContract","outputs":[{"name":"","type":"address"},{"name":"","type":"string"},{"name":"","type":"bytes32"}],"payable":false,"type":"function","stateMutability":"view"}];
    var addr = '0xd0146B2cBBc5e7F1d2b7247787c9Cd4ee8d40972';
    const web3 = new Web3(new Web3.providers.HttpProvider(provider));
    const contract = web3.eth.contract(abi).at(addr);
    

    // Function of Ethereum Account
    function unlockAccount(account, passphrase, callback){
        alert('unlockAccount');
        $.ajax({
            url: 'http://220.76.95.91:8546',
            type: 'post',
            datatype: 'application/json',
            contentType: 'application/json',
            dataType: 'JSON',
            data: JSON.stringify({
                id: 8,
                jsonrpc: '2.0',
                method: 'personal_unlockAccount',
                params: [account, passphrase]
            }),
            success: function(data) {
                if(data.result == true) {
                    callback(null);
                } else {
                    callback('fail auth');
                }
            },
            error: function(error) {
                callback(error);
            }
        });   
    }

    //authXML 엔진에 입력데이터와 구조데이터를 post방식의 파라미터로 request & response
    function createXML(){
        alert('createXML');
        bxfXmlSaveCspPrepare();
        bxfSearchTextPrepare();

        var inXML = $('#inXMLcontent').val();
        var calXML= $('#calXMLcontent').val();
        var apiKey= '5acda40a5de6a72c70b12679';
        var prams = 'apiKey='+apiKey+'&s_inXML='+inXML+'&s_calXML='+calXML;
        var url = 'http://xmlapi.datafarm.co.kr/soaxmlEngineApi.jsp';
        var client = new XMLHttpRequest();

        client.onreadystatechange = function(){
            if(client.readyState == 4 && client.status == 200) {
                var result = client.responseText.trim();
                // console.log(result.trim());
                writeChain(result);

            }
        }
        client.open("POST",url,true) ;
        
        client.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        // client.setHeader("Access-Control-Allow-Origin", "*");

        client.send(prams);
        // console.log(client.responseText);
    }

    function writeChain(xmlString){
        var curlDate = new Date();
        var fileName = curlDate.getFullYear().toString()+pad((curlDate.getMonth()+1).toString(),2)+pad(curlDate.getDate().toString(),2)+
                    pad(curlDate.getHours(),2)+pad(curlDate.getMinutes(),2)+pad(curlDate.getSeconds(),2)+'.xml';
        
        // alert($('#account'));
        web3.eth.defaultAccount=web3.eth.accounts[0]
        contract.issue(fileName, web3.sha3(xmlString), {from:$('#account').val(), gas: 500000});
        alert('계약서가 만들어졌습니다.')
        location.href='/home';
    }

    function pad(n, width) {
        n = n + '';//string 변환
        return n.length >= width ? n : new Array(width - n.length + 1).join('0') + n;
    }   

    function saveSoaxml(){
        unlockAccount($('#account').val(), $('#passphrase').val(), function(error){
            if(error == 'fail auth') {
                alert('인증정보가 올바르지 않습니다.');
            } else if(error) {
                throw error;
            } else {   
                createXML();
            }
        });
    }

</script>